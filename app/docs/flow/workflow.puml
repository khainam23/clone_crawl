@startuml Arealty Crawler Workflow
!theme plain
skinparam backgroundColor #FEFEFE
skinparam handwritten false
skinparam defaultFontName Arial
skinparam defaultFontSize 12

title Luồng Hoạt Động Hệ Thống Arealty Crawler

|#LightBlue|Khởi động Ứng dụng|
start
:Chạy **run.py**;
note right
  Entry point của ứng dụng
  Sử dụng Uvicorn server
end note

:Khởi tạo **FastAPI App**
(app/main.py);

:Kết nối **MongoDB**
(connect_to_mongo);
note right
  - Sử dụng Motor (async driver)
  - Test connection với ping
  - Lưu instance vào mongodb.database
end note

:Khởi động **APScheduler**
(start_scheduler);
note right
  - AsyncIOScheduler
  - Timezone từ settings
  - MemoryJobStore
end note

|#LightGreen|Đăng ký Jobs|
:Load **job_registry**
(app/jobs/index.py);

:Import các job modules:
- print_job.py
- mitsui_job.py
- tokyu_job.py;

:Mỗi job tự đăng ký
vào job_registry;
note right
  Job config bao gồm:
  - func: async function
  - trigger: 'cron'
  - seconds: interval
  - id: unique job id
end note

:Scheduler thêm tất cả
jobs đã đăng ký;

|#LightCoral|API Server|
fork
  :Lắng nghe HTTP requests
  trên host:port;
  
  :Endpoint **/api/v1/health**
  (Health check);
  
  :Swagger UI: **/docs**
  ReDoc: **/redoc**;
fork again

|#LightYellow|Job Execution (Mitsui)|
  repeat
    :Trigger **crawl_mitsui()**
    theo lịch (mỗi 8 giây);
    
    :Xóa dữ liệu cũ
    trong collection;
    note right
      SaveUtils.clean_db()
      Collection: mitsui_properties
    end note
    
    :Gọi **crawl_multi()**;
    
    partition "Thu thập URLs" {
      :Request đến trang danh sách
      Mitsui (với pagination);
      
      :Parse HTML với BeautifulSoup;
      
      :Trích xuất URLs từ
      data-js-room-link;
      
      :Lưu danh sách URLs;
    }
    
    partition "Crawl Chi tiết" {
      :Gọi **crawl_pages()**
      với batch processing;
      
      :Khởi tạo
      **EnhancedPropertyCrawler**;
      
      :Setup **CustomExtractor**
      cho Mitsui;
      note right
        - PropertyDataExtractor
        - ImageExtractor
        - CoordinateConverter
      end note
      
      :Crawl từng batch URLs
      (parallel processing);
      
      repeat :Với mỗi URL;
        :Fetch HTML content;
        
        :Extract property data:
        - Thông tin cơ bản
        - Hình ảnh
        - Tọa độ
        - Tiện ích;
        
        :Validate và transform data;
      repeat while (Còn URLs?) is (yes)
      ->no;
    }
    
    partition "Lưu trữ" {
      :Tổng hợp kết quả;
      
      :Lưu vào MongoDB
      (SaveUtils.save_db_results);
      note right
        Collection: mitsui_properties
        Document ID: từ config
      end note
    }
    
    :Log kết quả
    (success/error);
    
  repeat while (Scheduler active?) is (yes)
  ->no;

fork again

|#LightYellow|Job Execution (Tokyu)|
  repeat
    :Trigger **crawl_tokyu()**
    theo lịch (mỗi 8 giây);
    
    :Xóa dữ liệu cũ
    trong collection;
    note right
      SaveUtils.clean_db()
      Collection: tokyu_properties
    end note
    
    :Gọi **crawl_multi()**;
    
    partition "Thu thập URLs" {
      :Request đến trang danh sách
      Tokyu (với pagination);
      
      :Parse HTML với BeautifulSoup;
      
      :Trích xuất URLs;
      
      :Lưu danh sách URLs;
    }
    
    partition "Crawl Chi tiết" {
      :Gọi **crawl_pages()**
      với batch processing;
      
      :Khởi tạo
      **EnhancedPropertyCrawler**;
      
      :Setup **CustomExtractor**
      cho Tokyu;
      note right
        - PropertyDataExtractor
        - ImageExtractor
        - MapExtractor
      end note
      
      :Crawl từng batch URLs
      (parallel processing);
      
      repeat :Với mỗi URL;
        :Fetch HTML content;
        
        :Extract property data:
        - Thông tin cơ bản
        - Hình ảnh
        - Bản đồ
        - Tiện ích;
        
        :Validate và transform data;
      repeat while (Còn URLs?) is (yes)
      ->no;
    }
    
    partition "Lưu trữ" {
      :Tổng hợp kết quả;
      
      :Lưu vào MongoDB
      (SaveUtils.save_db_results);
      note right
        Collection: tokyu_properties
        Document ID: từ config
      end note
    }
    
    :Log kết quả
    (success/error);
    
  repeat while (Scheduler active?) is (yes)
  ->no;

end fork

|#LightBlue|Tắt Ứng dụng|
:Nhận signal shutdown;

:Dừng **Scheduler**
(stop_scheduler);

:Đóng kết nối **MongoDB**
(close_mongo_connection);

stop

legend right
  |= Thành phần |= Công nghệ |
  | Web Framework | FastAPI |
  | Scheduler | APScheduler |
  | Database | MongoDB (Motor) |
  | HTTP Client | Requests |
  | HTML Parser | BeautifulSoup4 |
  | Crawler Engine | Crawl4AI |
endlegend

@enduml